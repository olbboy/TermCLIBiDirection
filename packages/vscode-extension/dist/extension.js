"use strict";var Ie=Object.create;var G=Object.defineProperty;var Pe=Object.getOwnPropertyDescriptor;var Te=Object.getOwnPropertyNames;var Oe=Object.getPrototypeOf,Ce=Object.prototype.hasOwnProperty;var M=(i,e)=>()=>(e||i((e={exports:{}}).exports,e),e.exports),be=(i,e)=>{for(var t in e)G(i,t,{get:e[t],enumerable:!0})},ee=(i,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Te(e))!Ce.call(i,s)&&s!==t&&G(i,s,{get:()=>e[s],enumerable:!(n=Pe(e,s))||n.enumerable});return i};var D=(i,e,t)=>(t=i!=null?Ie(Oe(i)):{},ee(e||!i||!i.__esModule?G(t,"default",{value:i,enumerable:!0}):t,i)),ke=i=>ee(G({},"__esModule",{value:!0}),i);var te=M(_=>{"use strict";Object.defineProperty(_,"__esModule",{value:!0});_.Methods=_.ErrorCodes=void 0;_.createRequest=Be;_.createNotification=Ne;_.createSuccessResponse=Me;_.createErrorResponse=xe;_.isRequest=je;_.isNotification=Ge;_.isResponse=He;_.isErrorResponse=Le;_.ErrorCodes={PARSE_ERROR:-32700,INVALID_REQUEST:-32600,METHOD_NOT_FOUND:-32601,INVALID_PARAMS:-32602,INTERNAL_ERROR:-32603,NO_ACTIVE_EDITOR:-32001,FILE_NOT_FOUND:-32002,PERMISSION_DENIED:-32003,TIMEOUT:-32004};_.Methods={EDITOR_GET_TEXT:"editor/getText",EDITOR_GET_SELECTION:"editor/getSelection",EDITOR_SET_CURSOR:"editor/setCursor",EDITOR_APPLY_EDIT:"editor/applyEdit",EDITOR_HIGHLIGHT:"editor/highlight",WORKSPACE_OPEN_FILE:"workspace/openFile",WORKSPACE_GET_DIAGNOSTICS:"workspace/getDiagnostics",WORKSPACE_GET_OPEN_FILES:"workspace/getOpenFiles",COMMAND_EXECUTE:"command/execute",TERMINAL_SEND_TEXT:"terminal/sendText",WINDOW_SHOW_MESSAGE:"window/showMessage",WINDOW_SHOW_QUICK_PICK:"window/showQuickPick",EDITOR_ON_CHANGE:"editor/onChange",EDITOR_ON_SAVE:"editor/onSave",EDITOR_ON_ACTIVE_CHANGE:"editor/onActiveChange",PING:"ping",GET_INFO:"getInfo"};var Ae=1;function Be(i,e){return{jsonrpc:"2.0",id:Ae++,method:i,params:e}}function Ne(i,e){return{jsonrpc:"2.0",method:i,params:e}}function Me(i,e){return{jsonrpc:"2.0",id:i,result:e}}function xe(i,e,t,n){return{jsonrpc:"2.0",id:i,error:{code:e,message:t,data:n}}}function je(i){return"method"in i&&"id"in i}function Ge(i){return"method"in i&&!("id"in i)}function He(i){return"id"in i&&!("method"in i)}function Le(i){return"error"in i}});var oe=M(u=>{"use strict";var Fe=u&&u.__createBinding||(Object.create?function(i,e,t,n){n===void 0&&(n=t);var s=Object.getOwnPropertyDescriptor(e,t);(!s||("get"in s?!e.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(i,n,s)}:function(i,e,t,n){n===void 0&&(n=t),i[n]=e[t]}),We=u&&u.__setModuleDefault||(Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e}),L=u&&u.__importStar||function(){var i=function(e){return i=Object.getOwnPropertyNames||function(t){var n=[];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(n[n.length]=s);return n},i(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var n=i(e),s=0;s<n.length;s++)n[s]!=="default"&&Fe(t,e,n[s]);return We(t,e),t}}();Object.defineProperty(u,"__esModule",{value:!0});u.BridgeClient=u.MessageReader=u.BRIDGE_VERSION=u.BRIDGE_INFO_PATH=u.BRIDGE_SOCKET_PATH=u.BRIDGE_DIR=void 0;u.scanForVSCodeSockets=ie;u.findBridgeSocket=se;u.isSocketAlive=V;u.discoverAllSockets=$e;u.frameMessage=re;u.getIPCExportCommand=Ke;u.generateAutoInjectScript=qe;var ne=L(require("net")),b=L(require("fs")),x=L(require("path")),q=L(require("os"));u.BRIDGE_DIR=x.join(q.homedir(),".bidirection");u.BRIDGE_SOCKET_PATH=x.join(u.BRIDGE_DIR,"bridge.sock");u.BRIDGE_INFO_PATH=x.join(u.BRIDGE_DIR,"bridge.info");u.BRIDGE_VERSION="1.0.0";function ie(){let i=[],e=[];if(process.platform==="darwin"){let n=process.env.TMPDIR||"/tmp";e.push(n),e.push(x.join(q.tmpdir()))}else{let n=process.getuid?.();n!==void 0&&e.push(`/run/user/${n}`),e.push("/tmp"),e.push(q.tmpdir())}let t=[...new Set(e.map(n=>b.realpathSync(n)))];for(let n of t)try{let s=b.readdirSync(n);for(let r of s)if(r.startsWith("vscode-ipc-")&&r.endsWith(".sock")){let o=x.join(n,r);try{let d=b.statSync(o);i.push({path:o,type:"vscode-ipc",age:Date.now()-d.mtimeMs,active:!1})}catch{}}}catch{}return i.sort((n,s)=>n.age-s.age),i}function se(){try{if(b.existsSync(u.BRIDGE_INFO_PATH)){let i=JSON.parse(b.readFileSync(u.BRIDGE_INFO_PATH,"utf-8"));if(i.socketPath&&b.existsSync(i.socketPath))return{path:i.socketPath,type:"bidirection-bridge",age:Date.now()-(i.startedAt||Date.now()),active:!1}}if(b.existsSync(u.BRIDGE_SOCKET_PATH))return{path:u.BRIDGE_SOCKET_PATH,type:"bidirection-bridge",age:0,active:!1}}catch{}return null}async function V(i,e=2e3){return new Promise(t=>{let n=ne.createConnection({path:i},()=>{n.destroy(),t(!0)});n.on("error",()=>t(!1)),n.setTimeout(e,()=>{n.destroy(),t(!1)})})}async function $e(){let i=[],e=se();e&&(e.active=await V(e.path),i.push(e));let t=ie();for(let n of t)n.active=await V(n.path),i.push(n);return i}function re(i){let e=JSON.stringify(i),t=Buffer.from(e,"utf-8"),n=Buffer.alloc(4);return n.writeUInt32BE(t.length,0),Buffer.concat([n,t])}var H=class{constructor(e,t=()=>{}){this.buffer=Buffer.alloc(0),this.onMessage=e,this.onError=t}feed(e){for(this.buffer=Buffer.concat([this.buffer,e]);this.buffer.length>=4;){let t=this.buffer.readUInt32BE(0);if(t>50*1024*1024){this.onError(new Error(`Message too large: ${t} bytes`)),this.buffer=Buffer.alloc(0);return}if(this.buffer.length<4+t)break;let n=this.buffer.slice(4,4+t).toString("utf-8");this.buffer=this.buffer.slice(4+t);try{let s=JSON.parse(n);this.onMessage(s)}catch(s){this.onError(new Error(`Failed to parse message: ${s}`))}}}reset(){this.buffer=Buffer.alloc(0)}};u.MessageReader=H;var U=class{constructor(e={}){this.socket=null,this.pendingRequests=new Map,this.notificationHandlers=new Map,this.connected=!1,this.socketPath=e.socketPath||u.BRIDGE_SOCKET_PATH,this.explicitSocketPath=!!e.socketPath,this.timeout=e.timeout||1e4,this.reader=new H(t=>this.handleMessage(t),t=>console.error("[BiDirection] Parse error:",t.message))}async connect(){return new Promise((e,t)=>{if(!this.explicitSocketPath)try{if(b.existsSync(u.BRIDGE_INFO_PATH)){let n=JSON.parse(b.readFileSync(u.BRIDGE_INFO_PATH,"utf-8"));n.socketPath&&(this.socketPath=n.socketPath)}}catch{}this.socket=ne.createConnection({path:this.socketPath},()=>{this.connected=!0,this.socket?.unref(),e()}),this.socket.on("data",n=>this.reader.feed(n)),this.socket.on("error",n=>{this.connected||t(n)}),this.socket.on("close",()=>{this.connected=!1;for(let[n,s]of this.pendingRequests)clearTimeout(s.timer),s.reject(new Error("Connection closed")),this.pendingRequests.delete(n)})})}async request(e,t){if(!this.socket||!this.connected)throw new Error("Not connected to bridge");let n=Date.now()+Math.random(),s={jsonrpc:"2.0",id:n,method:e,params:t};return new Promise((r,o)=>{let d=setTimeout(()=>{this.pendingRequests.delete(n),o(new Error(`Request timeout: ${e}`))},this.timeout);this.pendingRequests.set(n,{resolve:r,reject:o,timer:d}),this.socket.write(re(s))})}onNotification(e,t){this.notificationHandlers.set(e,t)}disconnect(){this.socket&&(this.socket.destroy(),this.socket=null,this.connected=!1)}isConnected(){return this.connected}handleMessage(e){if("id"in e&&!("method"in e)){let t=this.pendingRequests.get(e.id);t&&(clearTimeout(t.timer),this.pendingRequests.delete(e.id),"error"in e?t.reject(new Error(`${e.error.message} (code: ${e.error.code})`)):t.resolve(e.result));return}if("method"in e&&!("id"in e)){let t=this.notificationHandlers.get(e.method);t&&t(e.params)}}};u.BridgeClient=U;function Ke(i){return`export VSCODE_IPC_HOOK_CLI="${i}"`}function qe(){return`
# BiDirection: Auto-inject VSCODE_IPC_HOOK_CLI
# Add this to your ~/.zshrc or ~/.bashrc
bidirection_inject() {
  local sock
  sock=$(ls -t \${TMPDIR:-/tmp}/vscode-ipc-*.sock 2>/dev/null | head -1)
  if [ -n "$sock" ] && [ -S "$sock" ]; then
    export VSCODE_IPC_HOOK_CLI="$sock"
  fi
}
bidirection_inject
`.trim()}});var ue=M(g=>{"use strict";var Ve=g&&g.__createBinding||(Object.create?function(i,e,t,n){n===void 0&&(n=t);var s=Object.getOwnPropertyDescriptor(e,t);(!s||("get"in s?!e.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(i,n,s)}:function(i,e,t,n){n===void 0&&(n=t),i[n]=e[t]}),Ue=g&&g.__setModuleDefault||(Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e}),J=g&&g.__importStar||function(){var i=function(e){return i=Object.getOwnPropertyNames||function(t){var n=[];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(n[n.length]=s);return n},i(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var n=i(e),s=0;s<n.length;s++)n[s]!=="default"&&Ve(t,e,n[s]);return Ue(t,e),t}}();Object.defineProperty(g,"__esModule",{value:!0});g.ANTIGRAVITY_PATHS=void 0;g.listBrainConversations=ce;g.getBrainArtifacts=Ye;g.readBrainArtifact=Qe;g.getBrainLogs=Xe;g.listKnowledgeItems=ae;g.readKnowledgeArtifact=ze;g.searchKnowledge=Ze;g.detectCurrentConversation=et;var p=J(require("path")),Je=J(require("os")),m=J(require("fs")),k=Je.homedir();g.ANTIGRAVITY_PATHS={DATA_DIR:p.join(k,".gemini","antigravity"),BRAIN_DIR:p.join(k,".gemini","antigravity","brain"),KNOWLEDGE_DIR:p.join(k,".gemini","antigravity","knowledge"),CONVERSATIONS_DIR:p.join(k,".gemini","antigravity","conversations"),APP_SUPPORT:p.join(k,"Library","Application Support","Antigravity"),EXTENSIONS_DIR:p.join(k,".antigravity","extensions"),PLAYGROUND_DIR:p.join(k,".gemini","antigravity","playground"),RECORDINGS_DIR:p.join(k,".gemini","antigravity","browser_recordings")};function ce(){let i=g.ANTIGRAVITY_PATHS.BRAIN_DIR;if(!m.existsSync(i))return[];let e=m.readdirSync(i,{withFileTypes:!0}),t=[];for(let n of e){if(!n.isDirectory()||!/^[0-9a-f]{8}-/.test(n.name))continue;let s=p.join(i,n.name),o=m.readdirSync(s).filter(c=>!c.startsWith(".")).filter(c=>c.endsWith(".md")&&!c.includes(".resolved")&&!c.includes(".metadata")),d=new Date(0);try{d=m.statSync(s).mtime}catch{}t.push({id:n.name,path:s,artifacts:o,hasTask:o.includes("task.md"),hasPlan:o.includes("implementation_plan.md"),hasWalkthrough:o.includes("walkthrough.md"),modifiedAt:d})}return t.sort((n,s)=>s.modifiedAt.getTime()-n.modifiedAt.getTime()),t}function Ye(i){let e=p.join(g.ANTIGRAVITY_PATHS.BRAIN_DIR,i);if(!m.existsSync(e))return[];let t=m.readdirSync(e),n=[],s=t.filter(r=>r.endsWith(".md")&&!r.includes(".resolved")&&!r.includes(".metadata"));for(let r of s){let o=p.join(e,r),d=m.statSync(o),h=t.filter(Re=>Re.startsWith(r+".resolved")).length,R,Z=p.join(e,r+".metadata.json");if(m.existsSync(Z))try{R=JSON.parse(m.readFileSync(Z,"utf-8"))}catch{}n.push({name:r,path:o,size:d.size,modifiedAt:d.mtime,metadata:R,versions:h})}return n}function Qe(i,e){let t=p.join(g.ANTIGRAVITY_PATHS.BRAIN_DIR,i,e);return m.existsSync(t)?m.readFileSync(t,"utf-8"):null}function Xe(i){let e=p.join(g.ANTIGRAVITY_PATHS.BRAIN_DIR,i,".system_generated","logs");return m.existsSync(e)?m.readdirSync(e).filter(n=>n.endsWith(".txt")).map(n=>({name:n.replace(".txt",""),path:p.join(e,n),content:m.readFileSync(p.join(e,n),"utf-8")})):[]}function ae(){let i=g.ANTIGRAVITY_PATHS.KNOWLEDGE_DIR;if(!m.existsSync(i))return[];let e=m.readdirSync(i,{withFileTypes:!0}),t=[];for(let n of e){if(!n.isDirectory())continue;let s=p.join(i,n.name),r,o,d,c=p.join(s,"metadata.json");if(m.existsSync(c))try{r=JSON.parse(m.readFileSync(c,"utf-8")),o=r?.summary,d=r?.lastAccessed}catch{}let h=p.join(s,"artifacts"),R=[];m.existsSync(h)&&(R=de(h)),t.push({id:n.name,path:s,summary:o,lastAccessed:d,artifactPaths:R,metadata:r})}return t}function ze(i,e){let t=p.join(g.ANTIGRAVITY_PATHS.KNOWLEDGE_DIR,i,"artifacts",e);return m.existsSync(t)?m.readFileSync(t,"utf-8"):null}function Ze(i){let e=[],t=ae(),n=i.toLowerCase();for(let s of t){s.summary?.toLowerCase().includes(n)&&e.push({knowledgeId:s.id,file:"metadata.json",line:0,content:s.summary});for(let r of s.artifactPaths){let o=p.join(s.path,"artifacts",r);try{let c=m.readFileSync(o,"utf-8").split(`
`);for(let h=0;h<c.length;h++)c[h].toLowerCase().includes(n)&&e.push({knowledgeId:s.id,file:r,line:h+1,content:c[h].trim()})}catch{}}}return e.slice(0,50)}function de(i,e=""){let t=[],n=m.readdirSync(i,{withFileTypes:!0});for(let s of n){let r=e?p.join(e,s.name):s.name;s.isDirectory()?t.push(...de(p.join(i,s.name),r)):t.push(r)}return t}function et(){let i=ce();return i.length===0?null:i[0].id}});var me=M(y=>{"use strict";var tt=y&&y.__createBinding||(Object.create?function(i,e,t,n){n===void 0&&(n=t);var s=Object.getOwnPropertyDescriptor(e,t);(!s||("get"in s?!e.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(i,n,s)}:function(i,e,t,n){n===void 0&&(n=t),i[n]=e[t]}),nt=y&&y.__setModuleDefault||(Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e}),le=y&&y.__importStar||function(){var i=function(e){return i=Object.getOwnPropertyNames||function(t){var n=[];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(n[n.length]=s);return n},i(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var n=i(e),s=0;s<n.length;s++)n[s]!=="default"&&tt(t,e,n[s]);return nt(t,e),t}}();Object.defineProperty(y,"__esModule",{value:!0});y.listWorkflows=ge;y.getWorkflow=st;y.getOrCreateWorkflowDir=rt;y.listSkills=pe;y.getSkill=ct;var E=le(require("fs")),T=le(require("path")),Y=[".agents",".agent","_agents","_agent"];function it(i){for(let e of Y){let t=T.join(i,e);if(E.existsSync(t)&&E.statSync(t).isDirectory())return t}return null}function fe(i){let e=[];for(let t of Y){let n=T.join(i,t,"workflows");E.existsSync(n)&&E.statSync(n).isDirectory()&&e.push(n)}return e}function he(i){let e=i.match(/^---\s*\n([\s\S]*?)\n---\s*\n([\s\S]*)$/);if(!e)return{description:"",body:i};let t=e[1],n=e[2],s=t.match(/description:\s*(.+)/);return{description:s?s[1].trim().replace(/^["']|["']$/g,""):"",body:n}}function ge(i){let e=fe(i),t=[];for(let n of e){let s=E.readdirSync(n).filter(r=>r.endsWith(".md"));for(let r of s){let o=T.join(n,r),d=E.readFileSync(o,"utf-8"),{description:c,body:h}=he(d),R=r.replace(/\.md$/,"");t.push({name:r,slug:R,path:o,description:c,content:h,hasTurboAll:d.includes("// turbo-all")})}}return t}function st(i,e){return ge(i).find(n=>n.slug===e||n.name===e||n.slug.includes(e))||null}function rt(i){let e=fe(i);if(e.length>0)return e[0];let t=it(i),n=t?T.join(t,"workflows"):T.join(i,".agents","workflows");return E.mkdirSync(n,{recursive:!0}),n}function ot(i){let e=[];for(let t of Y){let n=T.join(i,t,"skills");E.existsSync(n)&&E.statSync(n).isDirectory()&&e.push(n)}return e}function pe(i){let e=ot(i),t=[];for(let n of e){let s=E.readdirSync(n,{withFileTypes:!0});for(let r of s){if(!r.isDirectory())continue;let o=T.join(n,r.name),d=T.join(o,"SKILL.md");if(!E.existsSync(d))continue;let c=E.readFileSync(d,"utf-8"),{description:h,body:R}=he(c);t.push({name:r.name,path:o,description:h,content:R,hasScripts:E.existsSync(T.join(o,"scripts")),hasExamples:E.existsSync(T.join(o,"examples"))})}}return t}function ct(i,e){return pe(i).find(n=>n.name===e||n.name.includes(e))||null}});var N=M(O=>{"use strict";var at=O&&O.__createBinding||(Object.create?function(i,e,t,n){n===void 0&&(n=t);var s=Object.getOwnPropertyDescriptor(e,t);(!s||("get"in s?!e.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(i,n,s)}:function(i,e,t,n){n===void 0&&(n=t),i[n]=e[t]}),F=O&&O.__exportStar||function(i,e){for(var t in i)t!=="default"&&!Object.prototype.hasOwnProperty.call(e,t)&&at(e,i,t)};Object.defineProperty(O,"__esModule",{value:!0});F(te(),O);F(oe(),O);F(ue(),O);F(me(),O)});var pt={};be(pt,{activate:()=>lt,deactivate:()=>gt});module.exports=ke(pt);var v=D(require("vscode"));var we=D(require("net")),S=D(require("fs")),l=D(N()),W=class{constructor(e,t=console.log){this.server=null;this.clients=new Map;this.handlers=new Map;this.nextClientId=1;this.socketPath=e||l.BRIDGE_SOCKET_PATH,this.onLog=t}registerHandler(e,t){this.handlers.set(e,t)}async start(){if(S.existsSync(l.BRIDGE_DIR)||S.mkdirSync(l.BRIDGE_DIR,{recursive:!0,mode:448}),S.existsSync(this.socketPath))try{S.unlinkSync(this.socketPath)}catch{throw new Error(`Cannot remove stale socket: ${this.socketPath}`)}return new Promise((e,t)=>{this.server=we.createServer(n=>this.handleConnection(n)),this.server.on("error",n=>{this.onLog(`[BiDirection] Server error: ${n.message}`),t(n)}),this.server.listen(this.socketPath,()=>{try{S.chmodSync(this.socketPath,384)}catch{}this.writeBridgeInfo(),this.onLog(`[BiDirection] Bridge server started at ${this.socketPath}`),e()})})}stop(){for(let[,e]of this.clients)e.socket.destroy();this.clients.clear(),this.server&&(this.server.close(),this.server=null);try{S.existsSync(this.socketPath)&&S.unlinkSync(this.socketPath),S.existsSync(l.BRIDGE_INFO_PATH)&&S.unlinkSync(l.BRIDGE_INFO_PATH)}catch{}this.onLog("[BiDirection] Bridge server stopped")}broadcast(e,t){let n=(0,l.createNotification)(e,t),s=(0,l.frameMessage)(n);for(let[,r]of this.clients)try{r.socket.write(s)}catch{}}getClientCount(){return this.clients.size}getSocketPath(){return this.socketPath}handleConnection(e){let t=this.nextClientId++,n=new l.MessageReader(r=>this.handleMessage(t,r),r=>this.onLog(`[BiDirection] Client ${t} parse error: ${r.message}`)),s={id:t,socket:e,reader:n,subscribedNotifications:new Set};this.clients.set(t,s),this.onLog(`[BiDirection] Client ${t} connected (total: ${this.clients.size})`),e.on("data",r=>n.feed(r)),e.on("close",()=>{this.clients.delete(t),this.onLog(`[BiDirection] Client ${t} disconnected (total: ${this.clients.size})`)}),e.on("error",r=>{this.onLog(`[BiDirection] Client ${t} error: ${r.message}`),this.clients.delete(t)})}async handleMessage(e,t){let n=this.clients.get(e);n&&((0,l.isRequest)(t)?await this.handleRequest(n,t):(0,l.isNotification)(t)&&this.onLog(`[BiDirection] Notification from client ${e}: ${t.method}`))}async handleRequest(e,t){let n=Date.now(),s;if(t.method==="ping")s=(0,l.createSuccessResponse)(t.id,{pong:!0,timestamp:Date.now(),version:l.BRIDGE_VERSION});else{let o=this.handlers.get(t.method);if(!o)s=(0,l.createErrorResponse)(t.id,l.ErrorCodes.METHOD_NOT_FOUND,`Method not found: ${t.method}`);else try{let d=await o(t.params);s=(0,l.createSuccessResponse)(t.id,d)}catch(d){let c=d instanceof Error?d:new Error(String(d));s=(0,l.createErrorResponse)(t.id,l.ErrorCodes.INTERNAL_ERROR,c.message)}}let r=Date.now()-n;this.onLog(`[BiDirection] ${t.method} \u2192 ${r}ms`);try{e.socket.write((0,l.frameMessage)(s))}catch{this.onLog(`[BiDirection] Failed to send response to client ${e.id}`)}}writeBridgeInfo(){let e={socketPath:this.socketPath,version:l.BRIDGE_VERSION,pid:process.pid,startedAt:Date.now()};try{S.writeFileSync(l.BRIDGE_INFO_PATH,JSON.stringify(e,null,2),{mode:384})}catch{this.onLog("[BiDirection] Warning: Could not write bridge.info")}}};var a=D(require("vscode")),I=D(N()),A=null;function dt(i){return A&&A.dispose(),A=a.window.createTextEditorDecorationType({backgroundColor:i||"rgba(255, 255, 0, 0.3)",isWholeLine:!0,overviewRulerColor:i||"rgba(255, 255, 0, 0.7)",overviewRulerLane:a.OverviewRulerLane.Full}),A}function $(){let i=a.window.activeTextEditor;if(!i){let e=new Error("No active editor");throw e.code=I.ErrorCodes.NO_ACTIVE_EDITOR,e}return i}function ve(i){let e=[];return i.registerHandler(I.Methods.EDITOR_GET_TEXT,async t=>{let n=t||{},s;return n.uri?s=await a.workspace.openTextDocument(a.Uri.file(n.uri)):s=$().document,{text:s.getText(),uri:s.uri.fsPath,languageId:s.languageId,lineCount:s.lineCount}}),i.registerHandler(I.Methods.EDITOR_GET_SELECTION,async t=>{let n=t||{},s=$();if(n.uri&&s.document.uri.fsPath!==n.uri)throw new Error(`Active editor (${s.document.uri.fsPath}) doesn't match requested URI (${n.uri})`);let r=s.selection;return{text:s.document.getText(r),uri:s.document.uri.fsPath,startLine:r.start.line,startCharacter:r.start.character,endLine:r.end.line,endCharacter:r.end.character}}),i.registerHandler(I.Methods.EDITOR_SET_CURSOR,async t=>{let n=t,s;if(n.uri){let d=await a.workspace.openTextDocument(a.Uri.file(n.uri));s=await a.window.showTextDocument(d)}else s=$();let r=new a.Position(n.line,n.character);return s.selection=new a.Selection(r,r),s.revealRange(new a.Range(r,r),a.TextEditorRevealType.InCenter),{success:!0}}),i.registerHandler(I.Methods.EDITOR_APPLY_EDIT,async t=>{let n=t,s=new a.WorkspaceEdit,r=a.Uri.file(n.uri);for(let c of n.edits){let h=new a.Range(new a.Position(c.startLine,c.startCharacter),new a.Position(c.endLine,c.endCharacter));s.replace(r,h,c.newText)}return{success:await a.workspace.applyEdit(s),uri:n.uri}}),i.registerHandler(I.Methods.EDITOR_HIGHLIGHT,async t=>{let n=t,s;if(n.uri){let c=await a.workspace.openTextDocument(a.Uri.file(n.uri));s=await a.window.showTextDocument(c)}else s=$();let r=dt(n.color),o=new a.Range(new a.Position(n.startLine,0),new a.Position(n.endLine,Number.MAX_SAFE_INTEGER));return s.setDecorations(r,[o]),s.selection=new a.Selection(new a.Position(n.startLine,0),new a.Position(n.endLine,Number.MAX_SAFE_INTEGER)),s.revealRange(o,a.TextEditorRevealType.InCenter),{success:!0}}),e.push(a.workspace.onDidChangeTextDocument(t=>{i.broadcast(I.Methods.EDITOR_ON_CHANGE,{uri:t.document.uri.fsPath,changes:t.contentChanges.map(n=>({startLine:n.range.start.line,startCharacter:n.range.start.character,endLine:n.range.end.line,endCharacter:n.range.end.character,text:n.text}))})})),e.push(a.workspace.onDidSaveTextDocument(t=>{i.broadcast(I.Methods.EDITOR_ON_SAVE,{uri:t.uri.fsPath})})),e.push(a.window.onDidChangeActiveTextEditor(t=>{t&&i.broadcast(I.Methods.EDITOR_ON_ACTIVE_CHANGE,{uri:t.document.uri.fsPath,languageId:t.document.languageId})})),e}function Q(){A&&(A.dispose(),A=null)}var f=D(require("vscode")),K=D(N()),ut={[f.DiagnosticSeverity.Error]:"error",[f.DiagnosticSeverity.Warning]:"warning",[f.DiagnosticSeverity.Information]:"info",[f.DiagnosticSeverity.Hint]:"hint"};function Se(i){i.registerHandler(K.Methods.WORKSPACE_OPEN_FILE,async e=>{let t=e,n=f.Uri.file(t.uri),s=await f.workspace.openTextDocument(n),r=await f.window.showTextDocument(s,{preview:t.preview!==!1});if(t.line!==void 0){let d=t.line,c=t.character||0,h=new f.Position(d,c);r.selection=new f.Selection(h,h),r.revealRange(new f.Range(h,h),f.TextEditorRevealType.InCenter)}return{success:!0,uri:t.uri}}),i.registerHandler(K.Methods.WORKSPACE_GET_DIAGNOSTICS,async e=>{let t=e||{},n=f.languages.getDiagnostics(),s=[];for(let[o,d]of n)if(!(t.uri&&o.fsPath!==t.uri))for(let c of d)s.push({uri:o.fsPath,line:c.range.start.line,character:c.range.start.character,endLine:c.range.end.line,endCharacter:c.range.end.character,message:c.message,severity:ut[c.severity]||"info",source:c.source});return{diagnostics:s}}),i.registerHandler(K.Methods.WORKSPACE_GET_OPEN_FILES,async()=>{let e=f.window.activeTextEditor?.document.uri.fsPath,t=[];for(let s of f.window.tabGroups.all)for(let r of s.tabs)if(r.input instanceof f.TabInputText){let o=r.input.uri.fsPath,d=!1,c="unknown";try{let h=f.workspace.textDocuments.find(R=>R.uri.fsPath===o);h&&(d=h.isDirty,c=h.languageId)}catch{}t.push({uri:o,isActive:o===e,isDirty:d,languageId:c})}return{files:t}})}var j=D(require("vscode")),_e=D(N());function Ee(i){i.registerHandler(_e.Methods.TERMINAL_SEND_TEXT,async e=>{let t=e,n;return t.terminalName?(n=j.window.terminals.find(r=>r.name===t.terminalName),n||(n=j.window.createTerminal(t.terminalName))):(n=j.window.activeTerminal,n||(n=j.window.createTerminal("BiDirection"))),n.show(),n.sendText(t.text,t.addNewLine!==!1),{success:!0}})}var P=D(require("vscode")),B=D(N());function ye(i){i.registerHandler(B.Methods.WINDOW_SHOW_MESSAGE,async e=>{let t=e,n=t.actions||[],s;switch(t.type){case"warning":s=await P.window.showWarningMessage(t.message,...n);break;case"error":s=await P.window.showErrorMessage(t.message,...n);break;default:s=await P.window.showInformationMessage(t.message,...n)}return{selectedAction:s}}),i.registerHandler(B.Methods.WINDOW_SHOW_QUICK_PICK,async e=>{let t=e,n=t.items.map(o=>({label:o.label,description:o.description,detail:o.detail}));return{selectedItem:(await P.window.showQuickPick(n,{title:t.title,placeHolder:t.placeholder}))?.label}}),i.registerHandler(B.Methods.COMMAND_EXECUTE,async e=>{let t=e;return{result:await P.commands.executeCommand(t.command,...t.args||[])}}),i.registerHandler(B.Methods.GET_INFO,async()=>{let e=P.workspace.workspaceFolders?.map(n=>n.uri.fsPath)||[];return{name:"BiDirection Bridge",version:B.BRIDGE_VERSION,ide:"vscode",ideVersion:P.version,socketPath:i.getSocketPath(),pid:process.pid,workspaceFolders:e}})}var w=null,C,X;async function lt(i){X=v.window.createOutputChannel("BiDirection Bridge"),C=v.window.createStatusBarItem(v.StatusBarAlignment.Right,100);let e=n=>{X.appendLine(`[${new Date().toISOString()}] ${n}`)};i.subscriptions.push(v.commands.registerCommand("bidirection.startBridge",()=>De(e)),v.commands.registerCommand("bidirection.stopBridge",()=>ft(e)),v.commands.registerCommand("bidirection.showStatus",()=>ht()),C,X),v.workspace.getConfiguration("bidirection").get("autoStart",!0)&&await De(e)}async function De(i){if(w){v.window.showInformationMessage("BiDirection Bridge is already running");return}try{let t=v.workspace.getConfiguration("bidirection").get("socketPath","")||void 0;w=new W(t,i);let n=ve(w);Se(w),Ee(w),ye(w),await w.start(),z(!0),i(`Bridge started successfully at ${w.getSocketPath()}`),v.window.showInformationMessage(`BiDirection Bridge started at ${w.getSocketPath()}`);for(let s of n)s.dispose}catch(e){let t=e instanceof Error?e:new Error(String(e));i(`Failed to start bridge: ${t.message}`),v.window.showErrorMessage(`BiDirection Bridge failed to start: ${t.message}`),w=null,z(!1)}}function ft(i){if(!w){v.window.showInformationMessage("BiDirection Bridge is not running");return}w.stop(),w=null,Q(),z(!1),i("Bridge stopped"),v.window.showInformationMessage("BiDirection Bridge stopped")}function ht(){if(w){let i=w.getClientCount();v.window.showInformationMessage(`BiDirection Bridge: Running at ${w.getSocketPath()} | ${i} client(s) connected`)}else v.window.showInformationMessage("BiDirection Bridge: Not running")}function z(i){i&&w?(C.text="$(plug) BiDirection",C.tooltip=`Bridge: ${w.getSocketPath()} (${w.getClientCount()} clients)`,C.command="bidirection.showStatus",C.show()):(C.text="$(debug-disconnect) BiDirection",C.tooltip="Bridge not running. Click to start.",C.command="bidirection.startBridge",C.show())}function gt(){w&&(w.stop(),w=null),Q()}0&&(module.exports={activate,deactivate});
